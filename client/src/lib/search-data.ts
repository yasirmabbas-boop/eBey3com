export const SEARCH_SUGGESTIONS = [
  { ar: "ساعات", en: "watches", category: "ساعات" },
  { ar: "ساعة رولكس", en: "rolex watch", category: "ساعات" },
  { ar: "ساعة سيكو", en: "seiko watch", category: "ساعات" },
  { ar: "ساعة كاسيو", en: "casio watch", category: "ساعات" },
  { ar: "ساعة أوميغا", en: "omega watch", category: "ساعات" },
  { ar: "ساعة تاغ هوير", en: "tag heuer watch", category: "ساعات" },
  { ar: "ساعة باتيك فيليب", en: "patek philippe watch", category: "ساعات" },
  { ar: "ساعة أوديمار بيغيه", en: "audemars piguet watch", category: "ساعات" },
  { ar: "ساعة كرونوغراف", en: "chronograph watch", category: "ساعات" },
  { ar: "ساعة أوتوماتيكية", en: "automatic watch", category: "ساعات" },
  { ar: "ساعة كوارتز", en: "quartz watch", category: "ساعات" },
  { ar: "آيفون", en: "iphone", category: "إلكترونيات" },
  { ar: "آيفون 15", en: "iphone 15", category: "إلكترونيات" },
  { ar: "آيفون 14", en: "iphone 14", category: "إلكترونيات" },
  { ar: "آيفون 13", en: "iphone 13", category: "إلكترونيات" },
  { ar: "سامسونج", en: "samsung", category: "إلكترونيات" },
  { ar: "سامسونج جالكسي", en: "samsung galaxy", category: "إلكترونيات" },
  { ar: "ماك بوك", en: "macbook", category: "إلكترونيات" },
  { ar: "ماك بوك برو", en: "macbook pro", category: "إلكترونيات" },
  { ar: "ماك بوك اير", en: "macbook air", category: "إلكترونيات" },
  { ar: "لابتوب", en: "laptop", category: "إلكترونيات" },
  { ar: "كمبيوتر", en: "computer", category: "إلكترونيات" },
  { ar: "آيباد", en: "ipad", category: "إلكترونيات" },
  { ar: "تابلت", en: "tablet", category: "إلكترونيات" },
  { ar: "بلايستيشن", en: "playstation", category: "إلكترونيات" },
  { ar: "بلايستيشن 5", en: "playstation 5", category: "إلكترونيات" },
  { ar: "اكس بوكس", en: "xbox", category: "إلكترونيات" },
  { ar: "كاميرا", en: "camera", category: "إلكترونيات" },
  { ar: "كاميرا كانون", en: "canon camera", category: "إلكترونيات" },
  { ar: "كاميرا نيكون", en: "nikon camera", category: "إلكترونيات" },
  { ar: "سماعات", en: "headphones", category: "إلكترونيات" },
  { ar: "ايربودز", en: "airpods", category: "إلكترونيات" },
  { ar: "سيارة", en: "car", category: "سيارات" },
  { ar: "تويوتا", en: "toyota", category: "سيارات" },
  { ar: "مرسيدس", en: "mercedes", category: "سيارات" },
  { ar: "بي ام دبليو", en: "bmw", category: "سيارات" },
  { ar: "لكزس", en: "lexus", category: "سيارات" },
  { ar: "هوندا", en: "honda", category: "سيارات" },
  { ar: "نيسان", en: "nissan", category: "سيارات" },
  { ar: "كيا", en: "kia", category: "سيارات" },
  { ar: "هيونداي", en: "hyundai", category: "سيارات" },
  { ar: "ملابس", en: "clothing", category: "ملابس" },
  { ar: "فستان", en: "dress", category: "ملابس" },
  { ar: "بدلة", en: "suit", category: "ملابس" },
  { ar: "حقيبة", en: "bag", category: "ملابس" },
  { ar: "حقيبة لويس فيتون", en: "louis vuitton bag", category: "ملابس" },
  { ar: "حقيبة غوتشي", en: "gucci bag", category: "ملابس" },
  { ar: "حذاء", en: "shoes", category: "ملابس" },
  { ar: "حذاء نايكي", en: "nike shoes", category: "ملابس" },
  { ar: "حذاء اديداس", en: "adidas shoes", category: "ملابس" },
  { ar: "تحف", en: "antiques", category: "تحف وأثاث" },
  { ar: "أثاث", en: "furniture", category: "تحف وأثاث" },
  { ar: "سجاد", en: "carpet", category: "تحف وأثاث" },
  { ar: "سجاد فارسي", en: "persian carpet", category: "تحف وأثاث" },
  { ar: "لوحة فنية", en: "painting", category: "تحف وأثاث" },
  { ar: "مزهرية", en: "vase", category: "تحف وأثاث" },
  { ar: "ذهب", en: "gold", category: "أخرى" },
  { ar: "ذهب عراقي", en: "iraqi gold", category: "أخرى" },
  { ar: "مجوهرات", en: "jewelry", category: "أخرى" },
  { ar: "خاتم", en: "ring", category: "أخرى" },
  { ar: "سلسلة ذهب", en: "gold chain", category: "أخرى" },
  { ar: "عقد", en: "necklace", category: "أخرى" },
];

export const WATCH_BRANDS = [
  { ar: "رولكس", en: "Rolex" },
  { ar: "سيكو", en: "Seiko" },
  { ar: "كاسيو", en: "Casio" },
  { ar: "أوميغا", en: "Omega" },
  { ar: "تاغ هوير", en: "Tag Heuer" },
  { ar: "باتيك فيليب", en: "Patek Philippe" },
  { ar: "أوديمار بيغيه", en: "Audemars Piguet" },
  { ar: "كارتييه", en: "Cartier" },
  { ar: "بريتلينغ", en: "Breitling" },
  { ar: "تيسو", en: "Tissot" },
  { ar: "هاميلتون", en: "Hamilton" },
  { ar: "لونجين", en: "Longines" },
  { ar: "سيتيزن", en: "Citizen" },
  { ar: "جي شوك", en: "G-Shock" },
];

export const WATCH_MOVEMENTS = [
  { ar: "أوتوماتيكي", en: "Automatic (Self-Winding)" },
  { ar: "كوارتز", en: "Quartz" },
  { ar: "يدوي", en: "Manual Winding" },
  { ar: "سولار", en: "Solar" },
  { ar: "كينتيك", en: "Kinetic" },
];

export const WATCH_CASE_MATERIALS = [
  { ar: "ستانلس ستيل", en: "Stainless Steel" },
  { ar: "ذهب", en: "Gold" },
  { ar: "تيتانيوم", en: "Titanium" },
  { ar: "سيراميك", en: "Ceramic" },
  { ar: "بلاستيك", en: "Plastic" },
  { ar: "كربون", en: "Carbon" },
];

export const WATCH_BAND_MATERIALS = [
  { ar: "ستانلس ستيل", en: "Stainless Steel" },
  { ar: "جلد", en: "Leather" },
  { ar: "مطاط", en: "Rubber" },
  { ar: "نايلون", en: "Nylon" },
  { ar: "سيليكون", en: "Silicone" },
  { ar: "قماش", en: "Fabric" },
];

export const WATCH_DIAL_COLORS = [
  { ar: "أسود", en: "Black" },
  { ar: "أبيض", en: "White" },
  { ar: "أزرق", en: "Blue" },
  { ar: "أخضر", en: "Green" },
  { ar: "فضي", en: "Silver" },
  { ar: "ذهبي", en: "Gold" },
  { ar: "رمادي", en: "Gray" },
  { ar: "بني", en: "Brown" },
  { ar: "باندا", en: "Panda" },
  { ar: "ريفيرس باندا", en: "Reverse Panda" },
];

export const WATCH_FEATURES = [
  { ar: "كرونوغراف", en: "Chronograph" },
  { ar: "تاريخ", en: "Date" },
  { ar: "يوم/تاريخ", en: "Day/Date" },
  { ar: "مقاوم للماء", en: "Water Resistant" },
  { ar: "GMT", en: "GMT" },
  { ar: "مضيء", en: "Luminous" },
  { ar: "احتياطي الطاقة", en: "Power Reserve" },
  { ar: "توربيون", en: "Tourbillon" },
  { ar: "بوصلة", en: "Compass" },
  { ar: "منبه", en: "Alarm" },
];

export const WATCH_CASE_SIZES = [
  "34mm", "36mm", "38mm", "39mm", "40mm", "41mm", "42mm", "43mm", "44mm", "45mm", "46mm"
];

export const WATCH_SHAPES = [
  { ar: "دائري", en: "Round" },
  { ar: "مربع", en: "Square" },
  { ar: "مستطيل", en: "Rectangle" },
  { ar: "بيضاوي", en: "Oval" },
  { ar: "وسادة", en: "Cushion" },
  { ar: "تونو", en: "Tonneau" },
];

export const CONDITION_OPTIONS = [
  { ar: "جديد", en: "New", value: "new" },
  { ar: "ممتاز", en: "Excellent", value: "excellent" },
  { ar: "جيد جداً", en: "Very Good", value: "very_good" },
  { ar: "جيد", en: "Good", value: "good" },
  { ar: "مقبول", en: "Fair", value: "fair" },
  { ar: "للقطع", en: "For Parts", value: "for_parts" },
];

export const DEPARTMENT_OPTIONS = [
  { ar: "رجالي", en: "Men", value: "men" },
  { ar: "نسائي", en: "Women", value: "women" },
  { ar: "للجنسين", en: "Unisex", value: "unisex" },
];

export const CATEGORY_SPECIFICATIONS: Record<string, { fields: string[] }> = {
  "ساعات": {
    fields: ["brand", "model", "referenceNumber", "movement", "caseMaterial", "caseSize", "caseColor", "dialColor", "bandMaterial", "bandColor", "features", "watchShape", "department", "countryOfOrigin", "display", "indices", "handedness", "customized"]
  },
  "إلكترونيات": {
    fields: ["brand", "model", "storage", "ram", "screenSize", "color", "condition", "warranty", "accessories"]
  },
  "ملابس": {
    fields: ["brand", "size", "color", "material", "style", "gender"]
  },
  "سيارات": {
    fields: ["make", "model", "year", "mileage", "fuelType", "transmission", "color", "bodyType"]
  },
  "تحف وأثاث": {
    fields: ["type", "era", "material", "dimensions", "origin", "authenticity"]
  }
};

export const BRAND_SYNONYMS: Record<string, string[]> = {
  "omega": ["أوميغا", "اوميغا", "اوميجا", "أوميجا", "اومیغا", "اومیجا"],
  "rolex": ["رولكس", "رولکس", "روليكس", "رولیکس"],
  "seiko": ["سيكو", "سایکو", "سیکو", "سيکو"],
  "casio": ["كاسيو", "کاسیو", "كازيو", "كاسیو"],
  "tag heuer": ["تاغ هوير", "تاج هوير", "تاغ هيور", "تاج هيور", "تاغهوير"],
  "patek philippe": ["باتيك فيليب", "باتک فیلیپ", "باتيك فيلب", "باتیک فیلیپ"],
  "audemars piguet": ["أوديمار بيغيه", "اوديمار بيغيه", "اودیمار پیگه", "أوديمار بيجيه"],
  "cartier": ["كارتييه", "کارتیه", "كارتير", "کارتیر"],
  "breitling": ["بريتلينغ", "بریتلینگ", "بريتلنج", "برایتلینگ"],
  "tissot": ["تيسو", "تیسو", "تيسوت", "تیسوت"],
  "citizen": ["سيتيزن", "سیتیزن", "ستيزن", "ستیزن"],
  "hamilton": ["هاميلتون", "هامیلتون", "هاملتون", "هاملتن"],
  "longines": ["لونجين", "لونجینز", "لونجينز", "لونگینز"],
};

export const MODEL_SYNONYMS: Record<string, { brand: string; aliases: string[] }> = {
  "seamaster": { brand: "omega", aliases: ["سيماستر", "سیماستر", "سيمستر", "سی ماستر", "sea master"] },
  "speedmaster": { brand: "omega", aliases: ["سبيدماستر", "سبید ماستر", "سبيد ماستر", "speed master"] },
  "constellation": { brand: "omega", aliases: ["كونستيليشن", "کونستلیشن", "كونستلاشن"] },
  "submariner": { brand: "rolex", aliases: ["سابمارينر", "سابمارینر", "صب مارينر", "sub mariner"] },
  "datejust": { brand: "rolex", aliases: ["ديتجست", "دیتجست", "ديت جست", "date just"] },
  "daytona": { brand: "rolex", aliases: ["دايتونا", "دایتونا", "ديتونا"] },
  "presage": { brand: "seiko", aliases: ["بريساج", "پریساژ", "بريساچ"] },
  "prospex": { brand: "seiko", aliases: ["بروسبكس", "پروسپکس", "بروسبيكس"] },
  "royal oak": { brand: "audemars piguet", aliases: ["رويال اوك", "رویال اوک", "رويل أوك"] },
  "nautilus": { brand: "patek philippe", aliases: ["ناوتيلس", "ناوتیلس", "نوتيلوس"] },
  "carrera": { brand: "tag heuer", aliases: ["كاريرا", "کاریرا", "كريرا"] },
  "monaco": { brand: "tag heuer", aliases: ["موناكو", "موناکو", "مونكو"] },
  "tank": { brand: "cartier", aliases: ["تانك", "تانک", "طانك"] },
  "santos": { brand: "cartier", aliases: ["سانتوس", "سانتوز", "سانتس"] },
};

export const CATEGORY_KEYWORDS: Record<string, string[]> = {
  "ساعات": ["watch", "watches", "ساعة", "ساعات", "وقت", "timepiece", "wristwatch", "horology"],
  "إلكترونيات": ["electronics", "الكترونيات", "جهاز", "أجهزة", "phone", "laptop", "computer", "هاتف", "لابتوب", "كمبيوتر"],
  "ملابس": ["clothing", "clothes", "ملابس", "لبس", "fashion", "أزياء", "dress", "فستان"],
  "تحف وأثاث": ["antiques", "furniture", "تحف", "أثاث", "انتيك", "vintage", "فينتاج"],
  "سيارات": ["car", "cars", "سيارة", "سيارات", "vehicle", "مركبة", "auto"],
  "مجوهرات": ["jewelry", "jewellery", "مجوهرات", "ذهب", "gold", "diamond", "ألماس"],
};

function normalizeArabic(text: string): string {
  return text
    .replace(/[أإآا]/g, "ا")
    .replace(/[ىي]/g, "ی")
    .replace(/[ة]/g, "ه")
    .replace(/[ؤ]/g, "و")
    .replace(/[ئ]/g, "ی")
    .replace(/[\u064B-\u065F]/g, "")
    .trim();
}

function levenshteinDistance(a: string, b: string): number {
  const matrix: number[][] = [];
  for (let i = 0; i <= b.length; i++) matrix[i] = [i];
  for (let j = 0; j <= a.length; j++) matrix[0][j] = j;
  for (let i = 1; i <= b.length; i++) {
    for (let j = 1; j <= a.length; j++) {
      if (b.charAt(i - 1) === a.charAt(j - 1)) {
        matrix[i][j] = matrix[i - 1][j - 1];
      } else {
        matrix[i][j] = Math.min(
          matrix[i - 1][j - 1] + 1,
          matrix[i][j - 1] + 1,
          matrix[i - 1][j] + 1
        );
      }
    }
  }
  return matrix[b.length][a.length];
}

function fuzzyMatch(query: string, target: string, threshold: number = 0.7): boolean {
  const normalizedQuery = normalizeArabic(query.toLowerCase());
  const normalizedTarget = normalizeArabic(target.toLowerCase());
  
  if (normalizedTarget.includes(normalizedQuery) || normalizedQuery.includes(normalizedTarget)) {
    return true;
  }
  
  const distance = levenshteinDistance(normalizedQuery, normalizedTarget);
  const maxLength = Math.max(normalizedQuery.length, normalizedTarget.length);
  const similarity = 1 - distance / maxLength;
  
  return similarity >= threshold;
}

function matchesBrandOrModel(query: string): { brand?: string; model?: string; category?: string } | null {
  const normalizedQuery = normalizeArabic(query.toLowerCase());
  
  for (const [brand, synonyms] of Object.entries(BRAND_SYNONYMS)) {
    if (fuzzyMatch(query, brand) || synonyms.some(s => fuzzyMatch(query, s))) {
      return { brand, category: "ساعات" };
    }
  }
  
  for (const [model, data] of Object.entries(MODEL_SYNONYMS)) {
    if (fuzzyMatch(query, model) || data.aliases.some(a => fuzzyMatch(query, a))) {
      return { model, brand: data.brand, category: "ساعات" };
    }
  }
  
  return null;
}

function matchesCategory(query: string): string | null {
  const normalizedQuery = normalizeArabic(query.toLowerCase());
  
  for (const [category, keywords] of Object.entries(CATEGORY_KEYWORDS)) {
    if (keywords.some(k => fuzzyMatch(query, k, 0.6))) {
      return category;
    }
  }
  
  return null;
}

export interface SearchResult {
  ar: string;
  en: string;
  category: string;
  type: "category" | "brand" | "model" | "product";
  brand?: string;
  model?: string;
  score: number;
}

export function enhancedSearch(query: string): SearchResult[] {
  if (!query || query.length < 1) return [];
  
  const results: SearchResult[] = [];
  const normalizedQuery = normalizeArabic(query.toLowerCase().trim());
  const queryTokens = normalizedQuery.split(/\s+/).filter(t => t.length > 0);
  
  const categoryMatch = matchesCategory(query);
  if (categoryMatch) {
    const catSuggestion = SEARCH_SUGGESTIONS.find(s => s.category === categoryMatch && s.ar === categoryMatch);
    if (catSuggestion) {
      results.push({
        ...catSuggestion,
        type: "category",
        score: 100
      });
    }
  }
  
  const brandModelMatch = matchesBrandOrModel(query);
  if (brandModelMatch) {
    if (brandModelMatch.model && brandModelMatch.brand) {
      const brandData = WATCH_BRANDS.find(b => b.en.toLowerCase() === brandModelMatch.brand);
      if (brandData) {
        results.push({
          ar: `${brandData.ar} ${brandModelMatch.model}`,
          en: `${brandData.en} ${brandModelMatch.model}`,
          category: "ساعات",
          type: "model",
          brand: brandModelMatch.brand,
          model: brandModelMatch.model,
          score: 95
        });
      }
    } else if (brandModelMatch.brand) {
      const brandData = WATCH_BRANDS.find(b => b.en.toLowerCase() === brandModelMatch.brand);
      if (brandData) {
        results.push({
          ar: `ساعة ${brandData.ar}`,
          en: `${brandData.en} watch`,
          category: "ساعات",
          type: "brand",
          brand: brandModelMatch.brand,
          score: 90
        });
      }
    }
  }
  
  if (queryTokens.length >= 2) {
    let detectedBrand: string | null = null;
    let detectedModel: string | null = null;
    
    for (const token of queryTokens) {
      const brandMatch = matchesBrandOrModel(token);
      if (brandMatch?.brand && !brandMatch.model) {
        detectedBrand = brandMatch.brand;
      }
      if (brandMatch?.model) {
        detectedModel = brandMatch.model;
        if (brandMatch.brand) detectedBrand = brandMatch.brand;
      }
    }
    
    if (detectedBrand && detectedModel) {
      const brandData = WATCH_BRANDS.find(b => b.en.toLowerCase() === detectedBrand);
      if (brandData) {
        const existingResult = results.find(r => r.brand === detectedBrand && r.model === detectedModel);
        if (!existingResult) {
          results.push({
            ar: `${brandData.ar} ${detectedModel}`,
            en: `${brandData.en} ${detectedModel.charAt(0).toUpperCase() + detectedModel.slice(1)}`,
            category: "ساعات",
            type: "model",
            brand: detectedBrand,
            model: detectedModel,
            score: 98
          });
        }
      }
    }
  }
  
  const directMatches = SEARCH_SUGGESTIONS.filter(item => {
    const arMatch = fuzzyMatch(query, item.ar, 0.5);
    const enMatch = fuzzyMatch(query, item.en, 0.5);
    return arMatch || enMatch;
  });
  
  directMatches.forEach(item => {
    if (!results.find(r => r.ar === item.ar && r.en === item.en)) {
      results.push({
        ...item,
        type: "product",
        score: 70
      });
    }
  });
  
  return results
    .sort((a, b) => b.score - a.score)
    .slice(0, 10);
}

export function searchSuggestions(query: string): typeof SEARCH_SUGGESTIONS {
  if (!query || query.length < 2) return [];
  
  const enhancedResults = enhancedSearch(query);
  return enhancedResults.map(r => ({
    ar: r.ar,
    en: r.en,
    category: r.category
  }));
}
